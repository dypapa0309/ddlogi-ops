# DDLOGI Ops Workflow (확정본)

## 0) 목적
- 채널톡 퍼널(고객 메시지 흐름)을 **상태 머신**으로 고정한다.
- “실제 입금 확인(SMS)”은 사람이 하되, 시스템 자동화는 **채널톡에 남긴 고객 행동(메시지)** 기준으로 처리한다.
- 프론트는 바닐라(HTML/CSS/JS)로 유지한다.

---

## 1) 상태 정의 (Status)

### 1) draft
- 자유 문의/불완전 문의 상태
- 필수 조건이 부족한 접수

### 2) quoted
- 홈페이지 계산기 주문서가 채널톡으로 들어온 상태
- 조건 + 금액(총액/예약금/잔금)이 포함되어 “견적 산출이 완료된 상태”
- 아직 고객 확정 의사/입금 의사 확인 전

### 3) pending_confirm
- 고객이 “네 진행 / 그대로 진행” 등 확정 의사를 표현한 상태
- 예약금 안내까지 진행 가능
- 아직 캘린더 등록(확정) 전

### 4) confirmed
- 고객이 채널톡에서 **입금완료 + 필수 정보(이름/전화/주소)**를 모두 제공한 상태
- 이 시점에 자동으로 캘린더에 일정 등록(확정)
- 날짜/시간 중복 제한 없음(기사 다수 운영 전제)

### 5) in_progress
- 운송 당일 작업 진행 상태

### 6) completed
- 작업 완료 상태

### 7) settled
- 기사 정산 완료 상태

### 8) closed
- 완전 종료(사후 처리 없음)

---

## 2) 상태 전이 (State Transition)

### A. draft → quoted
- 트리거: “홈페이지 견적 제출 고객” 메시지 수신(주문서 형식)
- 조건: 주문서에 아래 항목 포함
  - 이사 방식, 차량, 거리, 일정, 희망 시간, 출발지, 도착지
  - 예상금액, 예약금(20%), 잔금(80%)

> 주의: 주문서가 아니거나 필수 조건이 누락되면 draft 유지

---

### B. quoted → pending_confirm
- 트리거: 고객 답변에 아래 키워드 포함
  - “네”, “진행”, “그대로”, “확정”
- 결과: 배차 가능/운영 구조 안내 후 예약금 안내로 유도(자동 메시지 2개 연속 가능)

---

### C. pending_confirm → confirmed  ✅(자동 캘린더 등록 시점)
- 트리거: 채널톡 대화 내 정보가 아래를 **모두 충족**할 때
  1) 입금 완료 키워드 감지  
     - “입금”, “입금완료”, “보냈어요”, “송금”, “이체”
  2) 고객 이름 확보
  3) 고객 전화번호 확보
  4) 출발지 주소 확보
  5) 도착지 주소 확보
  6) 주문서(quoted) 기반의 일정/시간/금액 정보가 이미 존재

- 결과:
  - status = confirmed 로 전환
  - 캘린더에 일정 자동 등록(확정)
  - 확정 안내 메시지 발송

✅ 안전장치 A 적용:
- “입금완료”만 있고, 이름/전화/주소가 누락되면 절대 confirmed로 전환하지 않는다.

❌ 안전장치(중복 방지) 미적용:
- 같은 날짜/시간 중복은 허용한다(기사 다수 운영 전제).

---

### D. confirmed → in_progress
- 트리거: 운송 당일 “작업 시작” 처리(관리자/기사)

### E. in_progress → completed
- 트리거: 작업 완료 처리(기사)

### F. completed → settled
- 트리거: 정산 완료 처리(관리자)

### G. settled → closed
- 트리거: 이슈 없음 확인 후 종료(관리자)

---

## 3) 채널톡 퍼널 자동응답 원칙

### 1단계 – 견적 접수 후 자동 응답 (quoted 직후)
- 입금 언급 금지
- 고객 불안 제거: “현재 입력 조건 기준 추가금 없이 진행”
- 선택 유도: “네, 그대로 진행 / 수정”

### 2단계 – 고객이 “네 진행” 답변 (pending_confirm)
- 배차 가능 상태 안내
- 운영 구조 설명(확정 후 기사 배정, 작업 전 연락, 안내 금액 그대로 진행)
- 긴급성은 “입금 순 배정” 표현만 사용(방어적 단어 금지)

### 3단계 – 예약금 안내 (pending_confirm 이어서)
- “노쇼 방지” 같은 방어적 표현 금지
- 예약 확정 절차로만 안내
- 입금 후 “입금 완료” 요청

### 4단계 – 입금 완료 감지 (pending_confirm)
- “입금 확인 중” 안내
- 동시에 필수 정보 요청(이름/전화/출발지/도착지)

### 5단계 – confirmed 확정 메시지
- “예약 확정” 및 기사 배정/연락 예고
- 안내된 조건 기준 추가금 없이 진행(변동은 사전 협의)

---

## 4) 데이터(필수 필드) 기준

### 주문서(quoted)에서 확보되어야 하는 항목
- moveType, vehicle, distanceKm
- date, timeSlot(또는 “오전 8시” 같은 형태)
- fromAddress, toAddress
- totalAmount, depositAmount, balanceAmount

### confirmed를 위해 추가로 확보해야 하는 항목(채널톡 대화에서)
- customerName
- customerPhone
- (입금 완료 키워드 존재)
- fromAddress / toAddress 재확인(없으면 요청)

---

## 5) 주석
- 실제 입금 여부는 SMS로 사람이 확인하지만,
  시스템 자동 확정(confirmed) 기준은 “고객이 채널톡에서 남긴 행동/정보 완결”로 한다.
- 중복 슬롯 제한은 운영 규모(기사 수) 확대를 고려해 적용하지 않는다.
